import json
import csv

stat_list = []
symptoms_list = []
time_list = []
data_list = []
def generate_data():
    with open("json_files/stat_thrds.json", "r", encoding="utf8") as f0:
        i = 0
        for line in f0:
            stat_dict = {}
            i += 1
            print(i)
            stat = json.loads(line)
            stat_dict['thread_id'] = stat['_id']
            stat_dict['resolution_status'] = stat['resolution_status']
            stat_dict['number_replies'] = stat['number_replies']
            stat_list.append(stat_dict)

    with open("json_files/symptoms_thrds.json", "r", encoding="utf8") as f1:
        i = 0
        for line in f1:
            symptoms_dict = {}
            i += 1
            print(i)
            symptoms = json.loads(line)
            symptoms_dict['thread_id'] = symptoms['_id']
            symptoms = symptoms['symptom']
            symptoms = ','.join(symptoms)
            symptoms_dict['symptoms'] = symptoms
            symptoms_list.append(symptoms_dict)


    with open("json_files/timeStat_thrds.json", "r", encoding="utf8") as f2:
        i = 0
        for line in f2:
            time_dict = {}
            i += 1
            print(i)
            time = json.loads(line)
            time_dict['thread_id'] = time['_id']
            startDate = time['startDate']
            startDate = startDate['$date']
            time_dict['startDate'] = startDate
            endDate = time['endDate']['$date']
            time_dict['endDate'] = endDate
            duration = time['duration']['$numberLong']
            time_dict['duration'] = duration
            time_list.append(time_dict)
        #print(stat_list)
    i = 0
    for stat in stat_list:
        for symptoms in symptoms_list:
            if stat['thread_id'] == symptoms['thread_id']:
                stat['symptoms'] = symptoms['symptoms']
        for time in time_list:
            if stat['thread_id'] == time['thread_id']:
                stat['startDate'] = time['startDate']
                stat['endDate'] = time['endDate']
                stat['duration'] = time['duration']
        data_list.append(stat)
        print(i)
        i += 1
    with open("data.csv", "a", encoding="utf8") as f3:
        keys = list(data_list[0].keys())
        writer = csv.DictWriter(f3, fieldnames=keys)
        writer.writeheader()
        writer.writerows(data_list)

#print(len(data_list))

# write to csv file
def read_data():
    with open("../data/data.csv", "r", encoding="utf8") as f4:
        data_list = []
        i = 0
        for line in f4:
            i += 1
            if(i > 1):
                data_item = line.split(',')
                #print(data_item)
                print(i)
                data_list.append(data_item)
    return data_list


with open("../../util/json_files/malware_attribution_thrds.json", "r", encoding="utf8") as f5:
    malware_list = []
    i = 0
    for line in f5:
        i += 1
        print(i)
        malware_dict = {}
        malware = json.loads(line)
        malware_dict['thread_id'] = malware['post_id']
        malware_labels = malware['label']
        malware_labels = ';'.join(malware_labels)
        malware_dict['malware'] = malware_labels
        malware_list.append(malware_dict)
    print(len(malware_list))

with open("../../util/json_files/malware.csv", "a", encoding="utf8") as f6:
        keys = list(malware_list[0].keys())
        writer = csv.DictWriter(f6, fieldnames=keys)
        writer.writeheader()
        writer.writerows(malware_list)
